name: Update TF2 Prices

on:
  schedule:
    - cron: '*/15 * * * *'  # 15분마다 실행
  workflow_dispatch:          # 수동 실행도 가능

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch prices from backpack.tf
        env:
          BPTF_API_KEY: ${{ secrets.BPTF_API_KEY }}
          GIST_ID: 7a542432dab00eb708b372a19d3e5b90
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # 1) 현재 Gist에서 기존 config 읽기
          OLD_CONFIG=$(curl -sf \
            -H "Authorization: token ${GH_TOKEN}" \
            "https://api.github.com/gists/${GIST_ID}" | jq -r '.files["config.json"].content')
          OLD_KRW=$(echo "$OLD_CONFIG" | jq -r '.keyPriceKRW')

          # 2) IGetCurrencies → 키 가격(정제금속)
          CURRENCIES=$(curl -sf "https://backpack.tf/api/IGetCurrencies/v1?key=${BPTF_API_KEY}")
          METAL_PER_KEY=$(echo "$CURRENCIES" | jq -r '.response.currencies.keys.price.value // empty')

          # 3) IGetPrices → ToD Ticket 가격(정제금속)
          PRICES=$(curl -sf "https://backpack.tf/api/IGetPrices/v4?key=${BPTF_API_KEY}")
          TOD_METAL=$(echo "$PRICES" | jq -r '.response.items["Tour of Duty Ticket"].prices["6"]["0"]["Tradable"]["Non-Craftable"][0].value // empty')

          # 값이 있을 때만 업데이트
          if [ -n "$METAL_PER_KEY" ]; then
            NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

            # ToD 값이 없으면 기존 값 유지
            if [ -z "$TOD_METAL" ]; then
              TOD_METAL=$(echo "$OLD_CONFIG" | jq -r '.todTicketMetal')
            fi

            # 새 config 생성
            NEW_CONFIG=$(jq -n \
              --argjson krw "$OLD_KRW" \
              --argjson mpk "$METAL_PER_KEY" \
              --argjson tod "$TOD_METAL" \
              --arg ts "$NOW" \
              '{
                keyPriceKRW: $krw,
                metalPerKey: $mpk,
                todTicketMetal: $tod,
                lastUpdated: $ts
              }')

            # Gist 업데이트 (GitHub API)
            PAYLOAD=$(jq -n --arg content "$NEW_CONFIG" '{files: {"config.json": {content: $content}}}')
            curl -sf -X PATCH \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "https://api.github.com/gists/${GIST_ID}" > /dev/null

            echo "Updated: metalPerKey=$METAL_PER_KEY, todTicket=$TOD_METAL"
          else
            echo "API fetch failed, skipping update"
            exit 0
          fi
